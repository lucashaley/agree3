<% content_for :head do %>
  <!-- Open Graph Meta Tags for Social Media Sharing -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="we agree that <%= truncate(@statement.content, length: 100) %>">
  <meta property="og:description" content="<%= pluralize(@statement.get_upvotes.size, 'person') %> agree<%= 's' if @statement.get_upvotes.size == 1 %> with this statement">
  <meta property="og:image" content="<%= png_statement_url(@statement, mode: 'light', host: request.host_with_port) %>">
  <meta property="og:url" content="<%= statement_url(@statement, host: request.host_with_port) %>">
  <meta property="og:site_name" content="we agree that...">

  <!-- Twitter Card Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="we agree that <%= truncate(@statement.content, length: 100) %>">
  <meta name="twitter:description" content="<%= pluralize(@statement.get_upvotes.size, 'person') %> agree<%= 's' if @statement.get_upvotes.size == 1 %> with this statement">
  <meta name="twitter:image" content="<%= png_statement_url(@statement, mode: 'light', host: request.host_with_port) %>">
<% end %>

<p style="color: green"><%= notice %></p>

<!-- Show if user has voted for related statements -->
<%
  voted_ancestors = Current.user ? @statement.all_ancestors.select { |ancestor| Current.user.voted_for?(ancestor) } : []
  voted_descendants = Current.user ? @statement.all_descendants.select { |descendant| Current.user.voted_for?(descendant) } : []
%>

<% if voted_ancestors.any? || voted_descendants.any? %>
  <div class="alert alert-info my-4">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
    <div class="flex-1">
      <% if voted_ancestors.any? %>
        <div class="mb-2">
          <strong>You have already voted for <%= voted_ancestors.size == 1 ? 'a parent statement' : 'parent statements' %>:</strong>
          <ul class="list-disc ml-6 mt-2">
            <% voted_ancestors.each do |ancestor| %>
              <li>
                <%= link_to ancestor.content, statement_path(ancestor), class: "link link-hover" %>
              </li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <% if voted_descendants.any? %>
        <div>
          <strong>You have already voted for <%= voted_descendants.size == 1 ? 'a variant' : 'variants' %> of this statement:</strong>
          <ul class="list-disc ml-6 mt-2">
            <% voted_descendants.each do |descendant| %>
              <li>
                <%= link_to descendant.content, statement_path(descendant), class: "link link-hover" %>
              </li>
            <% end %>
          </ul>
        </div>
      <% end %>
    </div>
  </div>
<% end %>

<!-- Responsive layout: horizontal on large screens, vertical on small/medium -->
<div class="flex flex-col lg:flex-row gap-6 items-start">
  <!-- Main statement (left side on large screens) -->
  <div class="flex-shrink-0">
    <%= render partial: "statement_full", locals: { statement: @statement } %>
  </div>

  <!-- Right sidebar (parent + diff on large screens) -->
  <!-- AddToAny BEGIN -->
  <div class="a2a_kit a2a_kit_size_32 a2a_default_style">
  <a class="a2a_dd" href="https://www.addtoany.com/share"></a>
  <a class="a2a_button_facebook"></a>
  <a class="a2a_button_bluesky"></a>
  <a class="a2a_button_reddit"></a>
  </div>
  <script defer src="https://static.addtoany.com/menu/page.js"></script>
  <!-- AddToAny END -->
  <% if @statement.parent.present? %>
    <div class="flex flex-col gap-6 w-full lg:w-auto">
      <!-- Parent Statement -->
      <div>
        <h2 class="text-2xl font-bold mb-4">Parent Statement</h2>
        <%= link_to statement_path(@statement.parent) do %>
          <%= render partial: "statement_small", locals: { statement: @statement.parent } %>
        <% end %>
      </div>

      <!-- Show diff between current and parent statement -->
      <div>
        <h2 class="text-2xl font-bold mb-4">Changes from Parent</h2>
        <div class="card bg-base-200">
          <div class="card-body">
            <div class="diff-display font-mono text-sm">
              <%= raw Diffy::Diff.new(
                ERB::Util.html_escape(@statement.parent.content),
                ERB::Util.html_escape(@statement.content),
                include_plus_and_minus_in_html: true
              ).to_s(:html) %>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% end %>
</div>

  <style>
    .diff-display .diff ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .diff-display .diff li {
      padding: 2px 4px;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .diff-display .diff ins {
      background-color: #d4edda;
      color: #155724;
      text-decoration: none;
    }
    .diff-display .diff del {
      background-color: #f8d7da;
      color: #721c24;
      text-decoration: none;
    }
    .diff-display .diff li.ins {
      background-color: #d4edda;
    }
    .diff-display .diff li.del {
      background-color: #f8d7da;
    }
  </style>

<% if @statement.children.any? %>
  <div class="my-8">
    <h2 class="text-2xl font-bold mb-4">Variants (<%= @statement.descendant_count %>)</h2>
    <div class="overflow-x-auto">
      <table class="table table-zebra w-full">
        <thead>
          <tr>
            <th class="w-16">Rank</th>
            <th>Statement</th>
            <th class="w-24 text-center">Votes</th>
            <th class="w-24"></th>
          </tr>
        </thead>
        <tbody>
          <% @statement.all_descendants.sort_by { |s| s.get_upvotes.size }.reverse.each_with_index do |descendant, index| %>
            <tr>
              <td class="font-bold text-center"><%= index + 1 %></td>
              <td>
                <%= link_to descendant.content, statement_path(descendant), class: "link link-hover" %>
                <% if descendant.parent_id != @statement.id %>
                  <span class="badge badge-xs badge-ghost ml-2">nested</span>
                <% end %>
              </td>
              <td class="text-center font-semibold"><%= descendant.get_upvotes.size %></td>
              <td>
                <%= link_to "View", statement_path(descendant), class: "btn btn-sm btn-ghost" %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
<% end %>

<div class="flex gap-4 items-center my-4"
     data-controller="agreement"
     data-agreement-statement-id-value="<%= @statement.id %>"
     data-agreement-initial-state-value="<%= Current.user&.voted_for?(@statement) || false %>">

  <% if Current.user %>
    <%# Logged in users: use server-side action %>
    <% user_voted = Current.user.voted_for?(@statement) %>
    <%= button_to user_voted ? "Unagree" : "Agree",
        agree_statement_path(@statement),
        method: :post,
        class: "btn #{user_voted ? 'btn-warning' : 'btn-success'} btn-lg text-2xl px-12 py-6 h-auto min-h-0",
        id: 'agree-button',
        data: { turbo: false } %>
  <% else %>
    <%# Anonymous users: use Stimulus controller with localStorage %>
    <button data-action="click->agreement#toggle"
            data-agreement-target="button"
            data-default-text="Agree"
            data-agreed-text="Agreed âœ“"
            class="btn btn-success btn-lg text-2xl px-12 py-6 h-auto min-h-0">
      Agree
    </button>

    <div class="text-sm text-gray-500">
      <%= link_to "Sign in to save your agreements", sign_in_path, class: "link link-primary" %>
    </div>
  <% end %>

  <!-- Flag dropdown -->
  <div class="dropdown">
    <div tabindex="0" role="button" class="btn btn-ghost btn-sm">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
        <path stroke-linecap="round" stroke-linejoin="round" d="M3 3v1.5M3 21v-6m0 0l2.77-.693a9 9 0 016.208.682l.108.054a9 9 0 006.086.71l3.114-.732a48.524 48.524 0 01-.005-10.499l-3.11.732a9 9 0 01-6.085-.711l-.108-.054a9 9 0 00-6.208-.682L3 4.5M3 15V4.5" />
      </svg>
      Flag
    </div>
    <ul tabindex="0" class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-52 z-10">
      <% Statement::FLAG_TYPES.each do |flag_type| %>
        <li>
          <%= button_to flag_type,
              flag_statement_path(@statement, flag_type: flag_type),
              method: :post,
              class: 'btn btn-ghost btn-sm justify-start w-full',
              data: { turbo: false } %>
        </li>
      <% end %>
    </ul>
  </div>
</div>

<!-- Display current flags with counts -->
<% flag_counts = @statement.flag_counts %>
<% flags_with_counts = flag_counts.select { |_, count| count > 0 } %>

<% if flags_with_counts.any? %>
  <div class="my-4">
    <div class="flex gap-2 flex-wrap">
      <% flags_with_counts.each do |flag_type, count| %>
        <%
          # Assign different colors to each flag type
          badge_class = case flag_type
          when "Ad Hominem"
            "badge-error"
          when "Nonsensical"
            "badge-info"
          when "Inappropriate"
            "badge-warning"
          else
            "badge-neutral"
          end
        %>
        <div class="badge <%= badge_class %> gap-2 px-3 py-3">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 3v1.5M3 21v-6m0 0l2.77-.693a9 9 0 016.208.682l.108.054a9 9 0 006.086.71l3.114-.732a48.524 48.524 0 01-.005-10.499l-3.11.732a9 9 0 01-6.085-.711l-.108-.054a9 9 0 00-6.208-.682L3 4.5M3 15V4.5" />
          </svg>
          <span><%= flag_type %> (<%= count %>)</span>
          <% if Current.user && @statement.flagged_by_user?(Current.user, flag_type) %>
            <%= button_to unflag_statement_path(@statement, flag_type: flag_type),
                method: :delete,
                class: 'btn btn-ghost btn-xs btn-circle ml-1',
                data: { turbo: false, confirm: 'Remove your flag?' } do %>
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
              </svg>
            <% end %>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
<% end %>

<% if flash[:ancestor_warning] && flash[:ancestor_warning]['ancestor_contents'] %>
  <!-- Ancestor Vote Warning Modal -->
  <dialog id="ancestor_warning_modal" class="modal">
    <div class="modal-box">
      <h3 class="text-lg font-bold mb-4">Ancestor Vote Warning</h3>
      <p class="mb-4">You have already agreed with a parent statement of this one:</p>
      <ul class="list-disc ml-6 mb-4">
        <% flash[:ancestor_warning]['ancestor_contents'].each do |content| %>
          <li class="italic"><%= content %></li>
        <% end %>
      </ul>
      <p class="mb-4">By agreeing with this statement, your vote on the parent statement(s) will be removed.</p>
      <div class="modal-action">
        <%= button_to "Continue and Remove Parent Vote",
            agree_statement_path(@statement),
            method: :post,
            params: { confirm_ancestor_removal: 'true' },
            class: "btn btn-primary",
            data: { turbo: false } %>
        <button type="button" class="btn" onclick="ancestor_warning_modal.close()">Cancel</button>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>

  <script>
    // Show the modal when the page loads if there's an ancestor warning
    document.addEventListener('DOMContentLoaded', function() {
      ancestor_warning_modal.showModal();
    });
  </script>
<% end %>

<div class="my-4">
  <button class="btn btn-secondary" onclick="variant_modal.showModal()">Create Variant</button>
</div>

<div class="space-y-4">
  <div class="flex gap-2 flex-wrap">
    <%= link_to "Edit this statement", edit_statement_path(@statement), class: "btn btn-lg text-lg" %>
    <%= link_to "Back to statements", statements_path, class: "btn btn-lg text-lg" %>
    <%= link_to "SVG (Light)", svg_statement_path(@statement, mode: "light"), target: "_blank", class: "btn btn-outline btn-lg text-lg" %>
    <%= link_to "SVG (Dark)", svg_statement_path(@statement, mode: "dark"), target: "_blank", class: "btn btn-outline btn-lg text-lg" %>
    <%= link_to "PNG (Light)", png_statement_path(@statement, mode: "light"), target: "_blank", class: "btn btn-outline btn-lg text-lg" %>
    <%= link_to "PNG (Dark)", png_statement_path(@statement, mode: "dark"), target: "_blank", class: "btn btn-outline btn-lg text-lg" %>
    <%= link_to "JPG (Light)", jpg_statement_path(@statement, mode: "light"), target: "_blank", class: "btn btn-outline btn-lg text-lg" %>
    <%= link_to "JPG (Dark)", jpg_statement_path(@statement, mode: "dark"), target: "_blank", class: "btn btn-outline btn-lg text-lg" %>
  </div>

  <div class="flex gap-2 flex-wrap">
    <%
      share_text = "We agree that #{@statement.content}. #{statement_url(@statement)}"
      png_light_share_url = "https://bsky.app/intent/compose?text=#{ERB::Util.url_encode(share_text + " " + png_statement_url(@statement, mode: 'light'))}"
      png_dark_share_url = "https://bsky.app/intent/compose?text=#{ERB::Util.url_encode(share_text + " " + png_statement_url(@statement, mode: 'dark'))}"
      jpg_light_share_url = "https://bsky.app/intent/compose?text=#{ERB::Util.url_encode(share_text + " " + jpg_statement_url(@statement, mode: 'light'))}"
      jpg_dark_share_url = "https://bsky.app/intent/compose?text=#{ERB::Util.url_encode(share_text + " " + jpg_statement_url(@statement, mode: 'dark'))}"
    %>
    <%= link_to "Share PNG (Light) on Bluesky", png_light_share_url, target: "_blank", rel: "noopener", class: "btn btn-info btn-lg text-lg" %>
    <%= link_to "Share PNG (Dark) on Bluesky", png_dark_share_url, target: "_blank", rel: "noopener", class: "btn btn-info btn-lg text-lg" %>
    <%= link_to "Share JPG (Light) on Bluesky", jpg_light_share_url, target: "_blank", rel: "noopener", class: "btn btn-info btn-lg text-lg" %>
    <%= link_to "Share JPG (Dark) on Bluesky", jpg_dark_share_url, target: "_blank", rel: "noopener", class: "btn btn-info btn-lg text-lg" %>
  </div>

  <div class="flex gap-2 flex-wrap">
    <a href="<%= png_statement_path(@statement, mode: 'light') %>"
       download="statement-<%= @statement.id %>-light.png"
       class="btn btn-success btn-lg text-lg">
      Download PNG (Light) for Instagram
    </a>
    <a href="<%= png_statement_path(@statement, mode: 'dark') %>"
       download="statement-<%= @statement.id %>-dark.png"
       class="btn btn-success btn-lg text-lg">
      Download PNG (Dark) for Instagram
    </a>
    <a href="<%= jpg_statement_path(@statement, mode: 'light') %>"
       download="statement-<%= @statement.id %>-light.jpg"
       class="btn btn-success btn-lg text-lg">
      Download JPG (Light) for Instagram
    </a>
    <a href="<%= jpg_statement_path(@statement, mode: 'dark') %>"
       download="statement-<%= @statement.id %>-dark.jpg"
       class="btn btn-success btn-lg text-lg">
      Download JPG (Dark) for Instagram
    </a>
  </div>

  <div>
    <%= button_to "Destroy this statement", @statement, method: :delete, class: 'btn btn-primary' %>
  </div>
</div>

<!-- Modal for creating a variant -->
<dialog id="variant_modal" class="modal">
  <div class="modal-box">
    <h3 class="text-lg font-bold mb-4">Create a Variant</h3>

    <%= form_with url: create_variant_statement_path(@statement), method: :post, scope: :statement do |form| %>
      <div class="form-control">
        <%= form.label :content, "Statement Content", class: "label" %>
        <%= form.text_area :content, value: @statement.content, class: "textarea textarea-bordered w-full h-32", required: true %>
      </div>

      <div class="modal-action">
        <%= form.submit "Create Variant", class: "btn btn-primary" %>
        <button type="button" class="btn" onclick="variant_modal.close()">Cancel</button>
      </div>
    <% end %>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>close</button>
  </form>
</dialog>
